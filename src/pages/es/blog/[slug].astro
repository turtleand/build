---
import { getCollection } from 'astro:content';
import type { PostEntry } from '../../../utils/blog';
import { filterByLocale, filterPublished, findTranslationForLocale, getPostSlug, sortPosts } from '../../../utils/blog';
import PostPage from '../../../page-templates/PostPage.astro';
import type { Locale } from '../../../utils/i18n';

const pageLocale: Locale = 'es';

export async function getStaticPaths() {
	const locale: Locale = 'es';
	const allPosts = (await getCollection('posts')).filter(filterPublished);
	const posts = sortPosts(allPosts.filter(filterByLocale(locale)));

	return posts.map((post) => {
		const translated = findTranslationForLocale(allPosts, post.data.translationKey, 'en');
		const researchNotes =
			!post.data.isResearchNotes && post.data.translationKey
				? allPosts.find(
						(candidate) =>
							candidate.id !== post.id &&
							candidate.data.locale === locale &&
							candidate.data.isResearchNotes &&
							candidate.data.translationKey === post.data.translationKey
				  )
				: null;
		return {
			params: { slug: getPostSlug(post) },
			props: {
				post,
				translatedSlug: translated ? getPostSlug(translated) : null,
				researchNotesPost: researchNotes ?? null,
			},
		};
	});
}

const { post, translatedSlug, researchNotesPost } = Astro.props as {
	post: PostEntry;
	translatedSlug: string | null;
	researchNotesPost: PostEntry | null;
};
const alternateHref = translatedSlug ? `/blog/${translatedSlug}` : '/';
---

<PostPage
	post={post}
	locale={pageLocale}
	basePath="/es"
	alternateHref={alternateHref}
	researchNotesPost={researchNotesPost}
/>
