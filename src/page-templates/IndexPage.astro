---
import { getCollection } from 'astro:content';
import BlogLayout from '../layouts/BlogLayout.astro';
import PostCard from '../components/PostCard.astro';
import { POSTS_PER_PAGE, filterByLocale, filterPublished, formatDate, getPostSlug, sortPosts } from '../utils/blog';
import type { Locale } from '../utils/i18n';
import { getDictionary, otherLocale } from '../utils/i18n';
import homeSearchScript from '../scripts/home-search.ts?url';

interface Props {
	locale: Locale;
	basePath?: string;
}

const { locale, basePath = '' } = Astro.props as Props;
const dictionary = getDictionary(locale);
const posts = sortPosts((await getCollection('posts')).filter(filterPublished).filter(filterByLocale(locale)));
const featuredPosts = posts.filter((post) => post.data.featured);
const paginatedPosts = posts.slice(0, POSTS_PER_PAGE);
const totalPages = Math.max(1, Math.ceil(posts.length / POSTS_PER_PAGE));
const altLocale = otherLocale(locale);
const alternateHref = altLocale === 'es' ? '/es' : '/';
const alternateLabel = dictionary.navigation.locales[altLocale].aria;
const defaultCountLabel = dictionary.search.countResults.replace('{count}', '0');
const base = basePath === '/' ? '' : basePath;
const buildHref = (path: string) => {
	const normalized = path.startsWith('/') ? path : `/${path}`;
	return `${base}${normalized}`.replace(/\/{2,}/g, '/');
};

const stripMarkdown = (value: string) =>
	value
		.replace(/```[\s\S]*?```/g, ' ')
		.replace(/`[^`]*`/g, ' ')
		.replace(/!\[[^\]]*]\([^)]*\)/g, ' ')
		.replace(/\[[^\]]*]\([^)]*\)/g, ' ')
		.replace(/[#>*_~]/g, ' ')
		.replace(/<\/?[^>]+(>|$)/g, ' ')
		.replace(/\s+/g, ' ')
		.trim();

const escapeForScript = (payload: unknown) => JSON.stringify(payload).replace(/</g, '\\u003c');

const searchDocuments = posts.map((post) => {
	const slug = getPostSlug(post);
	const bodyText = stripMarkdown(post.body ?? '');
	return {
		id: slug,
		title: post.data.title,
		description: post.data.description,
		tags: post.data.tags,
		body: bodyText || post.data.description,
		href: buildHref(`/blog/${slug}`),
		dateLabel: formatDate(post.data.date, locale),
	};
});

const searchDataScript = escapeForScript(searchDocuments);
const searchConfigScript = escapeForScript({
	countResults: dictionary.search.countResults,
	defaultCount: defaultCountLabel,
	readMoreLabel: dictionary.buttons.readMore,
	tagsLabel: dictionary.postPage.tagsLabel,
});
---

<BlogLayout
	title={dictionary.site.title}
	description={dictionary.site.description}
	locale={locale}
	dictionary={dictionary}
	basePath={basePath}
	alternateHref={alternateHref}
	alternateLabel={alternateLabel}
>
	{featuredPosts.length > 0 && (
		<section id="featured" class="section">
			<div class="section-header">
				<h2>{dictionary.sections.featuredTitle}</h2>
				<p>{dictionary.sections.featuredDescription}</p>
			</div>
			<div class="grid">
				{featuredPosts.map((post) => (
					<PostCard post={post} locale={locale} basePath={basePath} dictionary={dictionary} />
				))}
			</div>
		</section>
	)}

	<section class="section" data-search-section>
		<div class="section-header">
			<h2>{dictionary.search.label}</h2>
			<p>{dictionary.sections.allDescription}</p>
		</div>
		<div class="search-panel">
			<label class="search-label" for="home-search">{dictionary.search.label}</label>
			<div class="search-input-row">
				<input
					id="home-search"
					type="search"
					class="search-input"
					name="home-search"
					placeholder={dictionary.search.placeholder}
					autocomplete="off"
					data-search-input
				/>
				<button class="pill subtle search-clear" type="button" data-search-clear aria-label={dictionary.search.clear}>
					{dictionary.search.clear}
				</button>
			</div>
			<p class="search-count" data-search-count>{defaultCountLabel}</p>
		</div>
		<p class="search-empty" data-search-empty hidden>{dictionary.search.empty}</p>
		<div class="grid search-results" data-search-grid hidden></div>
	</section>

	<section class="section">
		<div class="section-header">
			<h2>{dictionary.sections.allTitle}</h2>
			<p>{dictionary.sections.allDescription}</p>
		</div>
		<div class="grid" data-post-grid>
			{paginatedPosts.map((post) => (
				<PostCard post={post} locale={locale} basePath={basePath} dictionary={dictionary} />
			))}
		</div>

		{totalPages > 1 && (
			<nav class="pagination" aria-label="Pagination" data-pagination>
				<span class="pagination-label">{dictionary.pagination.label} 1 / {totalPages}</span>
				<a class="pill subtle" href={`${basePath}/page/2`}>{dictionary.pagination.next}</a>
			</nav>
		)}
	</section>
</BlogLayout>

<script type="application/json" id="home-search-data" set:html={searchDataScript}></script>
<script type="application/json" id="home-search-config" set:html={searchConfigScript}></script>
<div hidden aria-hidden="true" data-card-templates>
	{posts.map((post) => (
		<template data-card-template data-slug={getPostSlug(post)}>
			<PostCard post={post} locale={locale} basePath={basePath} dictionary={dictionary} />
		</template>
	))}
</div>
<script type="module" src={homeSearchScript}></script>

<style>
.section {
	margin-top: 1.5rem;
}

.section-header h2 {
	margin: 0;
	font-family: var(--font-heading);
	font-size: 1.6rem;
}

.section-header p {
	margin: 0.3rem 0 0;
	color: var(--text-muted);
}

.grid {
	display: grid;
	grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
	grid-auto-rows: 1fr;
	gap: 1.4rem;
	margin-top: 1.35rem;
	align-items: stretch;
}

.pagination {
	margin-top: 2.25rem;
	display: flex;
	gap: 0.75rem;
	align-items: center;
}

.pagination-label {
	color: var(--text-muted);
}

.search-panel {
	margin-top: 1rem;
	padding: 1.25rem;
	border: 1px solid var(--border);
	border-radius: var(--radius-lg);
	background: var(--surface-card);
	box-shadow: var(--shadow-soft);
}

.search-label {
	display: block;
	font-family: var(--font-heading);
	font-weight: 600;
	margin-bottom: 0.6rem;
}

.search-input-row {
	display: flex;
	gap: 0.75rem;
	align-items: center;
}

.search-input {
	flex: 1;
	border: 1px solid var(--border);
	border-radius: var(--radius-pill);
	padding: 0.65rem 1rem;
	font-size: 1rem;
	background: var(--surface-elevated);
	color: var(--text-base);
}

.search-input:focus {
	outline: 2px solid var(--accent);
	outline-offset: 2px;
}

.search-clear[hidden] {
	display: none;
}

.search-count {
	margin: 0.8rem 0 0;
	color: var(--text-muted);
	font-size: 0.95rem;
}

.search-empty {
	margin-top: 1.35rem;
	padding: 1rem;
	border-radius: var(--radius-lg);
	border: 1px dashed var(--border);
	text-align: center;
	background: var(--surface-card);
	color: var(--text-muted);
}

@media (max-width: 600px) {
	.search-panel {
		padding: 1rem;
	}

	.search-input-row {
		flex-direction: column;
		align-items: stretch;
	}

	.search-clear {
		width: 100%;
	}
}
</style>
